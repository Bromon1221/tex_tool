<!doctype html>
<html lang="ja" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>æ•°å¼æç”»ãƒ„ãƒ¼ãƒ«ï¼ˆLaTeXå…¥åŠ› & ãƒœã‚¿ãƒ³ç”Ÿæˆï¼‰</title>
  <style>
    :root{
      --bg:#0b1020; --card:#121834; --muted:#9fb0ff; --text:#e9ecff; --btn:#1e2959; --btnh:#2a3879;
    }
    [data-theme="light"]{ --bg:#f6f8ff; --card:#ffffff; --muted:#5264b8; --text:#0f172a; --btn:#e7eeff; --btnh:#d9e4ff; }
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font:16px/1.6 system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial,"Hiragino Kaku Gothic ProN","Noto Sans JP"}
    .wrap{max-width:980px;margin:40px auto;padding:0 16px}
    h1{font-size:clamp(20px,4vw,30px);margin:0 0 12px}
    .card{background:color-mix(in oklab, var(--card) 92%, transparent);border:1px solid color-mix(in oklab, var(--text) 12%, transparent);border-radius:14px;padding:18px;margin:14px 0}
    textarea{width:100%;min-height:140px;border-radius:10px;background:color-mix(in oklab, var(--bg) 92%, white 0%);color:var(--text);border:1px solid color-mix(in oklab, var(--text) 20%, transparent);padding:10px;font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace}
    .btn{appearance:none;border:0;border-radius:10px;padding:8px 12px;background:var(--btn);color:var(--text);font-size:14px;cursor:pointer}
    .btn:hover{background:var(--btnh)}
    .toolbar{display:flex;flex-wrap:wrap;gap:6px;margin-bottom:10px}
    .muted{color:var(--muted);font-size:13px}
    .actionbar{margin-top:10px;display:flex;gap:8px;flex-wrap:wrap}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .pill{padding:6px 10px;border-radius:999px;border:1px solid color-mix(in oklab, var(--text) 18%, transparent);background:transparent}
    .kbd{display:inline-block;padding:1px 6px;border-radius:6px;border:1px solid color-mix(in oklab, var(--text) 25%, transparent);font-size:12px}
    .output{background:color-mix(in oklab, var(--bg) 92%, white 0%);padding:10px;border-radius:10px;overflow:auto;font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace}
    .hist{display:flex;gap:8px;flex-wrap:wrap}
    .chip{border:1px solid color-mix(in oklab, var(--text) 18%, transparent);padding:6px 8px;border-radius:999px;background:transparent;cursor:pointer}
    .chip:hover{background:color-mix(in oklab, var(--text) 10%, transparent)}
  </style>
  <script>
    // MathJax è¨­å®šï¼ˆSVG å‡ºåŠ›ï¼ãƒ­ãƒ¼ã‚«ãƒ«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼‰
    window.MathJax = { tex:{inlineMath:[["$","$"],["\\(","\\)"]]}, svg:{fontCache:'local'} };
  </script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"></script>
</head>
<body>
  <div class="wrap">
    <div class="row" style="justify-content:space-between">
      <h1>æ•°å¼æç”»ãƒ„ãƒ¼ãƒ«</h1>
      <div class="row">
        <button id="themeToggle" class="btn">ğŸŒ— ãƒ†ãƒ¼ãƒåˆ‡æ›¿</button>
        <a class="btn" href="index.html">â† PDFãƒ„ãƒ¼ãƒ«ã¸</a>
      </div>
    </div>
    <p class="muted">LaTeXã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã™ã‚‹ã‹ã€ä¸‹ã®ãƒœã‚¿ãƒ³ã§æ•°å¼ã‚’è¿½åŠ ã€‚ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æç”»ãƒ»ã‚³ãƒ”ãƒ¼ãƒ»ç”»åƒä¿å­˜ãƒ»URLå…±æœ‰ãƒ»å±¥æ­´å¾©å…ƒã«å¯¾å¿œã—ã¾ã™ã€‚</p>

    <div class="card">
      <div class="toolbar" id="toolbar"></div>
      <div class="row">
        <label class="pill"><input type="checkbox" id="modeDisplay" checked style="accent-color:#6aa9ff"/> $$ ãƒ‡ã‚£ã‚¹ãƒ—ãƒ¬ã‚¤è¡¨ç¤º</label>
        <span class="muted">é¸æŠç¯„å›²ã‚’åˆ†æ•°ãƒ»ãƒ«ãƒ¼ãƒˆãƒ»æ‹¬å¼§ã§<em>åŒ…ã‚€</em>æŒ¿å…¥ã«å¯¾å¿œã€‚ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆï¼š<span class="kbd">âŒ˜/Ctrl</span>+<span class="kbd">Enter</span>ã§æç”»ã€<span class="kbd">âŒ˜/Ctrl</span>+<span class="kbd">C</span>ã§ã‚³ãƒ”ãƒ¼ã€‚</span>
      </div>
      <textarea id="input" placeholder="ã“ã“ã«LaTeXæ•°å¼ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ï¼ˆä¾‹ï¼š\\int_0^1 x^2\\,dx = 1/3ï¼‰"></textarea>
      <div class="actionbar">
        <button id="render" class="btn">æç”»</button>
        <button id="copy" class="btn">TeXã‚³ãƒ¼ãƒ‰ã‚’ã‚³ãƒ”ãƒ¼</button>
        <button id="saveSvg" class="btn">SVGä¿å­˜</button>
        <button id="savePng" class="btn">PNGä¿å­˜</button>
        <button id="shareUrl" class="btn">URLå…±æœ‰ãƒªãƒ³ã‚¯ä½œæˆ</button>
        <button id="clear" class="btn">ã‚¯ãƒªã‚¢</button>
      </div>
    </div>

    <div class="card">
      <h3>ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</h3>
      <div id="preview" class="output">ï¼ˆã“ã“ã«æ•°å¼ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ï¼‰</div>
    </div>

    <div class="card">
      <h3>ã‚³ãƒ¼ãƒ‰å‡ºåŠ›</h3>
      <div id="output" class="output"></div>
    </div>

    <div class="card">
      <h3>æœ€è¿‘ã®æ•°å¼ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜ï¼‰</h3>
      <div id="history" class="hist"></div>
    </div>
  </div>

  <script>
    // ===== ãƒ„ãƒ¼ãƒ«ãƒãƒ¼å®šç¾©ï¼ˆå¿…è¦ã«å¿œã˜ã¦è¿½åŠ ã—ã¦OKï¼‰
    const KEYS = [
      {label:'âˆ«', ins:'\\int'}, {label:'âˆ‘', ins:'\\sum'}, {label:'âˆ', ins:'\\prod'},
      {label:'åˆ†æ•°', ins:'\\frac{}{}'}, {label:'âˆš', ins:'\\sqrt{}'},
      {label:'å¾®åˆ† âˆ‚', ins:'\\partial'}, {label:'âˆ‡', ins:'\\nabla'}, {label:'âˆ', ins:'\\infty'},
      {label:'lim', ins:'\\lim'}, {label:'â†’', ins:'\\rightarrow'},
      {label:'^ ä¸Šã¤ã', ins:'^{ }'}, {label:'_ ä¸‹ã¤ã', ins:'_{ }'},
      {label:'( )', ins:'\\left(  \\right)'}, {label:'[ ]', ins:'\\left[  \\right]'}, {label:'{ }', ins:'\\left\\{  \\right\\}'},
      {label:'| |', ins:'\\left|  \\right|'}, {label:'ã€ˆ ã€‰', ins:'\\langle  \\rangle'},
      {label:'è¡Œåˆ—', ins:'\\begin{bmatrix}  &  \\  &  \\end{bmatrix}'},
      {label:'cases', ins:'\\begin{cases}  , & \\\\  , &  \\end{cases}'},
      {label:'Î¸', ins:'\\theta'}, {label:'Î»', ins:'\\lambda'}, {label:'Î¼', ins:'\\mu'}, {label:'Î½', ins:'\\nu'}, {label:'Ï€', ins:'\\pi'},
      {label:'â„', ins:'\\mathbb{R}'}, {label:'â„•', ins:'\\mathbb{N}'}, {label:'â„¤', ins:'\\mathbb{Z}'},
      {label:'å¾®åˆ† d/dx', ins:'\\frac{d}{dx} '}, {label:'åå¾®åˆ† âˆ‚/âˆ‚x', ins:'\\frac{\\partial}{\\partial x} '},
      {label:'ç©åˆ†_ä¸Šä¸‹é™', ins:'\\int_{ }^{ } '}, {label:'Î£_ä¸Šä¸‹é™', ins:'\\sum_{ }^{ } '},
    ];

    // ===== è¦ç´ å–å¾—
    const toolbar = document.getElementById('toolbar');
    const input = document.getElementById('input');
    const preview = document.getElementById('preview');
    const output = document.getElementById('output');
    const modeDisplay = document.getElementById('modeDisplay');
    const historyEl = document.getElementById('history');

    // ===== ãƒ„ãƒ¼ãƒ«ãƒãƒ¼ç”Ÿæˆ
    toolbar.innerHTML='';
    for(const k of KEYS){
      const b=document.createElement('button'); b.className='btn'; b.textContent=k.label; b.dataset.insert=k.ins; toolbar.appendChild(b);
    }

    // ===== é¸æŠç¯„å›²ã‚’"åŒ…ã‚€"æŒ¿å…¥
    toolbar.addEventListener('click', (e)=>{
      const btn = e.target.closest('button.btn'); if(!btn) return;
      const tpl = btn.dataset.insert;
      const s=input.selectionStart, epos=input.selectionEnd; const sel=input.value.slice(s, epos);
      let inserted = tpl;
      if(tpl==='\\frac{}{}') inserted = `\\frac{${sel||' '}}{ }`;
      else if(tpl==='\\sqrt{}') inserted = `\\sqrt{${sel||' '}}`;
      else if(tpl==='^{ }') inserted = `{${sel||''}}^{ }`;
      else if(tpl==='_{ }') inserted = `{${sel||''}}_{ }`;
      else if(tpl==='\\left(  \\right)') inserted = `\\left(${sel||' '}\\right)`;
      else if(tpl==='\\left[  \\right]') inserted = `\\left[${sel||' '}\\right]`;
      else if(tpl==='\\left\\{  \\right\\}') inserted = `\\left\\{${sel||' '}\\right\\}`;
      else if(tpl==='\\left|  \\right|') inserted = `\\left|${sel||' '}\\right|`;
      else if(tpl==='\\langle  \\rangle') inserted = `\\langle ${sel||' '} \\rangle`;
      else if(tpl==='\\int_{ }^{ } ') inserted = `\\int_{ }^{ } ${sel||''}\\,`;
      const newVal = input.value.slice(0,s) + inserted + input.value.slice(epos);
      input.value = newVal; const caret = s + inserted.length; input.focus(); input.selectionStart = input.selectionEnd = caret;
      renderMath();
    });

    // ===== è‡ªå‹•æç”» + å‡ºåŠ›
    function renderMath(){
      const code = input.value;
      const body = modeDisplay.checked ? `$$${code}$$` : `\\(${code}\\)`;
      preview.innerHTML = body;
      MathJax.typesetPromise([preview]);
      output.textContent = code;
      saveHistory(code);
    }
    input.addEventListener('input', renderMath);
    document.getElementById('render').addEventListener('click', renderMath);

    // ===== ã‚³ãƒ”ãƒ¼
    document.getElementById('copy').addEventListener('click',()=>{
      navigator.clipboard.writeText(input.value).then(()=>{ toast('TeXã‚³ãƒ¼ãƒ‰ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ'); });
    });

    // ===== ç”»åƒä¿å­˜ï¼ˆSVG / PNGï¼‰
    async function getSVGString(){
      await MathJax.typesetPromise([preview]);
      const svg = preview.querySelector('svg');
      return svg ? svg.outerHTML : null;
    }
    document.getElementById('saveSvg').addEventListener('click', async()=>{
      const svg = await getSVGString(); if(!svg) return;
      const blob = new Blob([svg], {type:'image/svg+xml'});
      downloadBlob(blob, 'formula.svg');
    });
    document.getElementById('savePng').addEventListener('click', async()=>{
      const svg = await getSVGString(); if(!svg) return;
      const img = new Image();
      const svgBlob = new Blob([svg], {type:'image/svg+xml'});
      const url = URL.createObjectURL(svgBlob);
      img.onload = ()=>{
        const scale = 2; // 2xè§£åƒåº¦
        const canvas = document.createElement('canvas');
        canvas.width = img.width*scale; canvas.height = img.height*scale;
        const ctx = canvas.getContext('2d');
        ctx.setTransform(scale,0,0,scale,0,0);
        ctx.drawImage(img,0,0);
        canvas.toBlob(b=>{ if(b) downloadBlob(b,'formula.png'); URL.revokeObjectURL(url); }, 'image/png');
      };
      img.src = url;
    });

    // ===== URL å…±æœ‰ï¼ˆãƒãƒƒã‚·ãƒ¥ã«ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ï¼‰
    function encodeHash(str){ return '#q=' + encodeURIComponent(str); }
    function decodeHash(){ const m=location.hash.match(/^#q=(.*)$/); return m? decodeURIComponent(m[1]) : ''; }
    document.getElementById('shareUrl').addEventListener('click',()=>{
      const link = location.origin + location.pathname + encodeHash(input.value);
      navigator.clipboard.writeText(link).then(()=> toast('å…±æœ‰URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ'));
      history.replaceState(null,'', encodeHash(input.value));
    });
    // ãƒãƒƒã‚·ãƒ¥ã‹ã‚‰ã®å¾©å…ƒ
    const q = decodeHash(); if(q){ input.value=q; renderMath(); }

    // ===== å±¥æ­´ï¼ˆlocalStorageï¼‰
    const KEY='math-history-v1';
    function loadHistory(){ try{ return JSON.parse(localStorage.getItem(KEY)||'[]'); }catch{return []} }
    function saveHistoryItem(code){
      const list = loadHistory().filter(x=>x!==code); // é‡è¤‡å‰Šé™¤
      list.unshift(code); while(list.length>15) list.pop();
      localStorage.setItem(KEY, JSON.stringify(list));
    }
    function saveHistory(code){ if(!code||!code.trim()) return; saveHistoryItem(code); renderHistory(); }
    function renderHistory(){
      const list = loadHistory(); historyEl.innerHTML='';
      for(const s of list){ const b=document.createElement('button'); b.className='chip'; b.textContent = s.length>32 ? s.slice(0,32)+'â€¦' : s; b.title=s; b.addEventListener('click',()=>{ input.value=s; renderMath(); }); historyEl.appendChild(b); }
    }
    renderHistory();

    // ===== ã‚¯ãƒªã‚¢
    document.getElementById('clear').addEventListener('click',()=>{
      input.value=''; preview.textContent='ï¼ˆã“ã“ã«æ•°å¼ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ï¼‰'; output.textContent=''; toast('ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ');
    });

    // ===== ãƒ†ãƒ¼ãƒåˆ‡æ›¿ï¼ˆä¿å­˜ï¼‰
    const themeToggle = document.getElementById('themeToggle');
    function setTheme(t){ document.documentElement.setAttribute('data-theme', t); localStorage.setItem('theme', t); }
    const t0 = localStorage.getItem('theme'); if(t0) setTheme(t0);
    themeToggle.addEventListener('click', ()=>{ const cur = document.documentElement.getAttribute('data-theme')||'dark'; setTheme(cur==='dark'?'light':'dark'); });

    // ===== å…±é€š util
    function downloadBlob(blob, filename){ const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=filename; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href), 1000); }
    function toast(msg){
      const d=document.createElement('div'); d.textContent=msg; d.style.cssText='position:fixed;left:50%;bottom:24px;transform:translateX(-50%);background:#0009;color:#fff;padding:8px 12px;border-radius:10px;z-index:9999';
      document.body.appendChild(d); setTimeout(()=>d.remove(),1500);
    }

    // ===== ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ
    document.addEventListener('keydown', (ev)=>{
      if((ev.metaKey||ev.ctrlKey) && ev.key==='Enter'){ ev.preventDefault(); renderMath(); }
      if((ev.metaKey||ev.ctrlKey) && ev.key.toLowerCase()==='c'){ if(document.activeElement===input){ ev.preventDefault(); navigator.clipboard.writeText(input.value).then(()=>toast('TeXã‚³ãƒ¼ãƒ‰ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ')); } }
    });
  </script>
</body>
</html>
